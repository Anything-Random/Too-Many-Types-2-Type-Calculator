<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Type Calculator</title>

<style>
/* ================= GLOBAL ================= */
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #111;
  color: #eee;
  /* Add padding to bottom so content isn't flush with window edge */
  padding-bottom: 3rem; 
}

/* ================= HEADER ================= */
header {
  display: flex;
  justify-content: center;
  gap: 1rem;
  padding: 1rem;
  background: #1c1c1c;
  margin-bottom: 2rem;
  border-bottom: 1px solid #333;
}

header button {
  padding: 0.6rem 1.2rem;
  font-size: 1rem;
  background: #333;
  color: #eee;
  border: none;
  border-radius: 4px; /* Slight rounded corners look nicer */
  cursor: pointer;
  transition: background 0.2s;
}

header button:hover {
  background: #444;
}

header button.active {
  background: #007acc; /* A nice highlight color */
  font-weight: bold;
}

/* ================= LAYOUT ================= */
/* This container prevents content from stretching to the edges */
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 0 1rem;
}

.view {
  display: none;
}

.view.active {
  display: block;
}

.description {
  background: #222;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #333;
  margin-bottom: 2rem;
  text-align: center;
  color: #ccc;
  line-height: 1.6;
}

.description a {
  color: #66b3ff;
}

/* ================= TABLES & INPUTS ================= */
select {
  background: #222;
  color: #eee;
  border: 1px solid #444;
  padding: 0.5rem;
  font-size: 1rem;
  border-radius: 4px;
  width: 100%; /* Fill the column width, not the screen width */
  box-sizing: border-box;
}

table {
  border-collapse: collapse;
  margin-top: 0.5rem;
  width: 100%;
}

th, td {
  border: 1px solid #444;
  padding: 8px;
  font-size: 0.9rem;
  text-align: center;
}

th {
  background: #222;
}

/* ================= CALCULATOR SPECIFIC ================= */
.calculator {
  display: grid;
  grid-template-columns: 1fr auto 1fr; /* Left, Middle, Right */
  gap: 2rem;
  align-items: start;
  background: #1a1a1a;
  padding: 2rem;
  border-radius: 8px;
  border: 1px solid #333;
}
  
.column {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}
  
.column h2 {
  margin: 0 0 0.5rem;
  text-align: center;
  font-size: 1.2rem;
  font-weight: 600;
  color: #fff;
  border-bottom: 2px solid #333;
  padding-bottom: 0.5rem;
}

.result {
  font-size: 3.5rem;
  font-weight: bold;
  min-width: 4ch;
  text-align: center;
  padding-top: 3.5rem; /* Align vertically with inputs */
  color: #fff;
  text-shadow: 0 0 10px rgba(255,255,255,0.1);
}

/* ================= TEAM SPECIFIC ================= */
#team-container > div {
  background: #1a1a1a;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #333;
}

#team-container strong {
  display: block;
  font-size: 1.2rem;
  margin-bottom: 1rem;
  color: #66b3ff;
}

/* Helper for the move rows */
.move-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}
</style>
</head>

<body>

<header>
  <button class="active" data-view="matchup">Move Effectiveness</button>
  <button data-view="team">Team Coverage</button>
  <button data-view="defence">Defensive Match-Up</button>
</header>

<div class="container">
  
  <div class="description">
    <p style="margin-top: 0;">
      This page contains some handy tools for the ROM hack Too Many Types 2,
      available at <a href="https://www.hackdex.app/hack/too-many-types-2" target="_blank">hackdex</a>.
    </p>
  </div>

  <div id="matchup" class="view active">
    
    <div class="description" style="text-align: left; font-size: 0.95rem;">
      <p>
        <strong>How to use:</strong> Select up to four types on each side to see how they interact.
        Remember that you can begin typing with a dropdown box selected to find a type.
      </p>
      <p>
        <em>Disclaimer:</em> I have no idea how the multi-type attacks work in
        this game, so I gave it my best guess. I just calculated the
        type effectiveness of each attack type individually against a
        defending pokemon and then multiplied them together. I allowed
        defending pokemon to have up to 4 types to account for
        type-adding moves. I wasn't sure how many types an attack can
        have, so I just made it symmetrical. I assume that the Uno type
        works by taking the reciprocal of the normal type effectiveness
        (i.e., 0.5x becomes 1/0.5 = 2x), and immunity just becomes 2x.
        Also, I wasn't sure how the Every type works, it seems like
        it has some special functionality, but I just used the numbers
        presented in the type chart and I will update it when any new
        info becomes available.
        If anyone has any corrections on how this works they can message
        me in the Too Many Productions discord @anything_random.
          </p>
    </div>

    <div class="calculator">
      <div class="column" id="attack-column">
        <h2>Attack Type(s)</h2>
        <select></select>
        <select></select>
        <select></select>
        <select></select>
      </div>

      <div class="result" id="result">—</div>

      <div class="column" id="defence-column">
        <h2>Defence Type(s)</h2>
        <select></select>
        <select></select>
        <select></select>
        <select></select>
      </div>
    </div>
  </div>

  <div id="team" class="view">
    <h2 style="text-align:center; margin-bottom: 1.5rem;">Team Coverage</h2>
    <div id="team-container"></div>

    <div style="background: #1a1a1a; padding: 1.5rem; border-radius: 8px; border: 1px solid #333; margin-top: 2rem;">
        <h3 style="margin-top:0; text-align: center;">Full Team Coverage</h3>
        <div id="team-total"></div>
    </div>
  </div>

  <div id="defence" class="view">
    <h2 style="text-align:center;">Defensive Match-Up</h2>
    <p style="text-align: center;">(To be implemented later)</p>
  </div>

</div> <script>
/* ===================== CONSTANTS ===================== */

const TYPES = [
  'Normal','Fighting','Flying','Poison','Ground','Rock','Bug','Ghost','Steel',
  'Mystery/Typeless','Fire','Water','Grass','Electric','Psychic','Ice','Dragon',
  'Dark','Fairy','Stellar','Ancient','Anime','Baby','Ball','Bean','Bird','Brat',
  'Boring','Cat','Crab','Dance','Deez Nuts','Emerald','Family','Fast','Firefight',
  'Florida','Fluffy','Food','Freak','Friend','Frog','Furry','Future','Gamer',
  'Gaslight','Gatekeep','Gender','Girlboss','Goblin','Goku','Gun','Guys','Hater',
  'Holy','Kaiju','Little','Magic','Mario','Monke','Ninja','Pikachu','Rat','Reddit',
  'Sans','Sharp','Silly','Song','Space','Stinky','Sus','Thing','Ugly','Unalive',
  'Uno','Vgc','Vibes','Wealth','Yapper','Every'
];

const TEAM_SIZE = 6;
const MOVES_PER_POKEMON = 4;

/* ===================== HELPERS ===================== */

function populateSelect(select) {
    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "—";
    select.appendChild(empty);

    for (const type of TYPES) {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      select.appendChild(option);
    }

    select.addEventListener("change", calculate);
}

// Populate the static selects in the Matchup tab
document.querySelectorAll("#matchup select").forEach(populateSelect);

async function calculate() {
    const attackers = [...document.querySelectorAll("#attack-column select")]
      .map(s => s.value)
      .filter(Boolean);

    const defenders = [...document.querySelectorAll("#defence-column select")]
      .map(s => s.value)
      .filter(Boolean);

    if (attackers.length === 0 || defenders.length === 0) {
      document.getElementById("result").textContent = "—";
      return;
    }

    try {
      const response = await fetch("/attack", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          attackers: attackers,
          defenders: defenders
        })
      });

      const data = await response.json();
      // Format to max 2 decimals if needed, or keep as is
      document.getElementById("result").textContent = `${data.multiplier}×`;
    } catch {
      document.getElementById("result").textContent = "ERR";
    }
}
  
function makeTypeSelect() {
  const s = document.createElement("select");
  const blank = document.createElement("option");
  blank.value = "";
  blank.textContent = "—";
  s.appendChild(blank);
  TYPES.forEach(t => {
    const o = document.createElement("option");
    o.value = t;
    o.textContent = t;
    s.appendChild(o);
  });
  return s;
}

function renderTable(container, data) {
  container.innerHTML = "";
  if (!data || Object.keys(data).length === 0) return;

  const table = document.createElement("table");
  const tr1 = document.createElement("tr");
  const tr2 = document.createElement("tr");

  // Sort keys alphabetically or logically if preferred, currently just Object order
  Object.entries(data).forEach(([type, val]) => {
    const th = document.createElement("th");
    th.textContent = type;
    const td = document.createElement("td");
    
    // Color coding for readability
    if(val > 1) td.style.color = "#ff6b6b"; // Red-ish for super effective
    if(val < 1) td.style.color = "#51cf66"; // Green-ish for not effective
    
    td.textContent = val + "×";
    tr1.appendChild(th);
    tr2.appendChild(td);
  });

  table.append(tr1, tr2);
  container.appendChild(table);
}

/* ===================== TEAM UI ===================== */

function buildTeamUI() {
  const container = document.getElementById("team-container");
  
  // Optimization: If we already built it, don't rebuild (clears selections otherwise)
  if (container.children.length > 0) return;

  container.innerHTML = "";

  for (let p = 0; p < TEAM_SIZE; p++) {
    const block = document.createElement("div");
    block.style.marginBottom = "1.5rem";
    block._moves = [];

    block.innerHTML = `<strong>Pokemon ${p + 1}</strong>`;

    for (let m = 0; m < MOVES_PER_POKEMON; m++) {
      const line = document.createElement("div");
      line.className = "move-row"; 

      const label = document.createElement("span");
      label.textContent = `Move ${m + 1}:`;
      label.style.minWidth = "60px";
      label.style.fontSize = "0.9rem";

      const s1 = makeTypeSelect();
      const s2 = makeTypeSelect();
      s2.style.display = "none";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = `p${p}m${m}-multi`;

      const cbLabel = document.createElement("label");
      cbLabel.textContent = "Dual Type?";
      cbLabel.setAttribute("for", `p${p}m${m}-multi`);
      cbLabel.style.fontSize = "0.8rem";
      cbLabel.style.cursor = "pointer";

      cb.onchange = () => {
        s2.style.display = cb.checked ? "inline-block" : "none";
        calculateTeam();
      };

      s1.onchange = s2.onchange = calculateTeam;

      line.append(label, s1, cb, cbLabel, s2);

      block._moves.push({ s1, s2, cb });
      block.appendChild(line);
    }

    const result = document.createElement("div");
    result.id = `pokemon-${p}`;
    result.style.marginTop = "1rem";
    result.style.overflowX = "auto"; // Scroll if table is too wide
    block.appendChild(result);

    container.appendChild(block);
  }
}

async function calculateTeam() {
  const rows = document.querySelectorAll("#team-container > div");
  const team = [];

  for (let i = 0; i < rows.length; i++) {
    const moves = [];
    // rows[i] is the block div. usage of _moves property attached to DOM element
    if (!rows[i]._moves) continue;

    for (const m of rows[i]._moves) {
      if (!m.s1.value) continue;
      if (m.cb.checked && m.s2.value)
        moves.push([m.s1.value, m.s2.value]);
      else
        moves.push([m.s1.value]);
    }

    if (moves.length === 0) continue;
    team.push(moves);

    try {
      const res = await fetch("/coverage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ moves })
      });
      renderTable(document.getElementById(`pokemon-${i}`), await res.json());
    } catch (e) { console.error(e); }
  }

  if (team.length === 0) {
      document.getElementById("team-total").innerHTML = "";
      return;
  }

  try {
    const teamRes = await fetch("/team-coverage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pokemons: team })
    });
    renderTable(document.getElementById("team-total"), await teamRes.json());
  } catch (e) { console.error(e); }
}

/* ===================== SPA NAV ===================== */

document.querySelectorAll("header button").forEach(btn => {
  btn.onclick = () => {
    // UI Toggles
    document.querySelectorAll("header button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    const viewId = btn.dataset.view;
    const viewElement = document.getElementById(viewId);
    
    if (viewElement) {
        viewElement.classList.add("active");
    } else {
        console.error(`View ID '${viewId}' not found.`);
    }

    // Logic Trigger
    if (viewId === "team") buildTeamUI();
  };
});
</script>

</body>
</html>
