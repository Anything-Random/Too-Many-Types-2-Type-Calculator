<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Type Calculator</title>

<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

<style>
/* ================= GLOBAL ================= */
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #111;
  color: #eee;
  padding-bottom: 3rem;
}

/* ================= HEADER ================= */
header {
  display: flex;
  justify-content: center;
  gap: 1rem;
  padding: 1rem;
  background: #1c1c1c;
  margin-bottom: 2rem;
  border-bottom: 1px solid #333;
}

header button {
  padding: 0.6rem 1.2rem;
  font-size: 1rem;
  background: #333;
  color: #eee;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

header button:hover {
  background: #444;
}

header button.active {
  background: #007acc;
  font-weight: bold;
}

/* ================= LAYOUT ================= */
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 0 1rem;
  transition: max-width 0.3s ease;
}

.container.wide {
  max-width: 95%;
}

.view {
  display: none;
}

.view.active {
  display: block;
}

.description {
  background: #222;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #333;
  margin-bottom: 2rem;
  text-align: center;
  color: #ccc;
  line-height: 1.6;
}

.description a {
  color: #66b3ff;
}

/* ================= SEARCH SECTIONS ================= */
.search-section {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  margin-bottom: 1.5rem;
  flex-wrap: wrap; /* Allow wrapping on small screens */
}

/* Standardized Input/Button styles for easier mobile control */
.styled-input {
  padding: 0.5rem;
  width: 70%;
  border-radius: 4px;
  border: 1px solid #444;
  background: #222;
  color: #eee;
  box-sizing: border-box; /* Ensures padding doesn't break width */
}

.styled-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  white-space: nowrap; /* Prevent text wrapping inside button */
}

.btn-clear {
  background: #cc3333;
  color: white;
}

.btn-search {
  background: #007acc;
  color: white;
}

/* ================= INPUTS ================= */
select {
  background: #222;
  color: #eee;
  border: 1px solid #444;
  padding: 0.5rem;
  font-size: 1rem;
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
}

/* ================= RESULT GRIDS ================= */
.group-header {
  margin-top: 1.5rem;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  color: #ccc;
  border-bottom: 1px solid #333;
  padding-bottom: 0.2rem;
}

.coverage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
  gap: 4px;
}

.type-cell {
  background: #111;
  border: 1px solid #444;
  display: flex;
  flex-direction: column;
}

.type-header {
  background: #222;
  padding: 6px;
  font-size: 0.75rem;
  text-align: center;
  border-bottom: 1px solid #444;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: bold;
}

.type-value {
  padding: 8px;
  text-align: center;
  font-size: 0.9rem;
  flex-grow: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ================= CALCULATOR SPECIFIC ================= */
.calculator {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 2rem;
  align-items: start;
  background: #1a1a1a;
  padding: 2rem;
  border-radius: 8px;
  border: 1px solid #333;
}

.column {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.column h2 {
  margin: 0 0 0.5rem;
  text-align: center;
  font-size: 1.2rem;
  font-weight: 600;
  color: #fff;
  border-bottom: 2px solid #333;
  padding-bottom: 0.5rem;
}

.result {
  font-size: 3.5rem;
  font-weight: bold;
  min-width: 4ch;
  text-align: center;
  padding-top: 3.5rem;
  color: #fff;
  text-shadow: 0 0 10px rgba(255,255,255,0.1);
}

/* ================= TEAM SPECIFIC ================= */
#team-container > div {
  background: #1a1a1a;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #333;
}

#team-container strong {
  display: block;
  font-size: 1.2rem;
  margin-bottom: 1rem;
  color: #66b3ff;
}

.move-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

/* ================= MOBILE RESPONSIVENESS ================= */
@media (max-width: 768px) {

  /* Inputs must be at least 16px to prevent iOS from zooming in */
  input, select, .styled-input {
    font-size: 16px !important;
  }

  /* Header: Stack buttons */
  header {
    flex-direction: column;
    gap: 0.5rem;
  }
  header button {
    width: 100%;
    text-align: center;
  }

  /* Layout: Reduce padding */
  .container {
    padding: 0 0.5rem;
  }

  /* Calculator: Stack vertically (Attacker -> Result -> Defender) */
  .calculator {
    grid-template-columns: 1fr;
    gap: 1rem;
    padding: 1rem;
  }

  /* Reset result padding so it sits nicely in the middle */
  .result {
    padding-top: 0;
    margin: 1rem 0;
  }

  /* Team Coverage: Wrap move rows */
  .move-row {
    flex-wrap: wrap;
    gap: 0.3rem;
  }

  /* Make "Move 1:" label take full width on mobile */
  .move-row > span {
    width: 100%;
    margin-bottom: 0.2rem;
    color: #999;
    font-size: 0.85rem;
  }

  /* Make selects full width for easier tapping */
  .move-row select {
    width: 100%;
    flex: 1 1 100%;
  }

  /* Search Sections: Stack Input and Button */
  .search-section {
    flex-direction: column;
  }

  /* Force large inputs/buttons to fill width */
  .styled-input,
  .styled-btn {
    width: 100% !important;
  }

  /* Exception for small inline buttons (Team Clear buttons) */
  .btn-inline {
    width: auto !important; /* Don't stretch */
    padding: 0.3rem 0.8rem; /* Keep padding tight */
    margin-left: 1rem;      /* Add space between text and button */
  }

  #purity-search {
      margin: 0 0 0.5rem 0 !important;
  }

  /* Hide extraneous text on mobile */
  .desktop-only {
    display: none !important;
  }
}
</style>
</head>

<body>

<header>
  <button class="active" data-view="matchup">Move Effectiveness</button>
  <button data-view="team">Team Coverage</button>
  <button data-view="defence">Defensive Match-Up</button>
</header>

<div class="container" id="main-container">

  <div class="description">
    <p style="margin-top: 0;">
      This page contains some handy tools for the ROM hack Too Many Types 2,
      available at <a href="https://www.hackdex.app/hack/too-many-types-2" target="_blank">hackdex</a>.
    </p>
  </div>

  <div id="matchup" class="view active">

    <div class="description" style="text-align: left; font-size: 0.95rem;">
      <p>
        <strong>How to use:</strong> Select up to two types for attack, and four types for defence.
          <span class="desktop-only">Remember that you can begin typing with a dropdown box selected to find a type.</span>
      </p>
      <p class="desktop-only">
        <em>Disclaimer:</em> I've made the assumption that the Uno Reverse type is calculated
        by taking the reciprocal of regular type effectiveness,
        with a special case of immunity becoming 2x. To account for edge cases,
        attacking moves can have up to 2 types, and
        defending Pokemon are allowed up to 4 types.
      </p>
        <p>
        If you have any corrections or suggestions, you can message
        me in the <a href=https://discord.com/invite/PADwE683Nk>Too Many Productions</a> Discord @anything_random.
        </p>
    </div>
    <div style="text-align: right; margin-bottom: 1rem;">
        <button onclick="clearMatchup()" class="styled-btn btn-clear">Clear</button>
    </div>
    <div class="calculator">
      <div class="column" id="attack-column">
        <h2>Attacking Move Type(s)</h2>
        <select id="atk-s1"></select>

        <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem;">
            <input type="checkbox" id="atk-dual">
            <label for="atk-dual" style="cursor:pointer; font-size:0.9rem;">Dual Type?</label>
        </div>

        <select id="atk-s2" style="display:none; margin-top:0.5rem;"></select>
      </div>

      <div class="result" id="result">—</div>

      <div class="column" id="defence-column">
        <h2>Defending Pokemon Type(s)</h2>
        <select></select>
        <select></select>
        <select></select>
        <select></select>
      </div>
    </div>
  </div>

  <div id="team" class="view">
    <div class="description" style="text-align: left; font-size: 0.95rem;">
      <p>
        <strong>How to use:</strong> Select types for up to 4 moves per Pokemon for a team of up to 6 Pokemon.
        Under each Pokemon you can see their individual type coverage, and at the bottom you
        can see your entire team's type coverage.
      </p>
      <p class="desktop-only">
          <span style="color: #ff6b6b; font-weight: bold;">Red</span> = Resisted<br>
          <span style="color: #51cf66; font-weight: bold;">Green</span> = Super Effective
      </p>
    </div>

    <h2 style="text-align:center; margin-bottom: 1.5rem;">Team Coverage</h2>

    <div style="text-align: right; margin-bottom: 1rem;">
      <button onclick="clearFullTeam()" class="styled-btn btn-clear">Clear All</button>
    </div>

    <div id="team-container"></div>

    <div style="background: #1a1a1a; padding: 1.5rem; border-radius: 8px; border: 1px solid #333; margin-top: 2rem;">
        <h3 style="margin-top:0; text-align: center;">Full Team Coverage</h3>
        <div id="team-total"></div>
    </div>
  </div>

  <div id="defence" class="view">
    <div class="description" style="text-align: left; font-size: 0.95rem;">
        <p>
          <strong>How to use:</strong> Search for a Pokemon below OR select up to 4 types manually.
          The grid below will show how effective every type is against it.
        </p>
        <p class="desktop-only">
            Sorting and colours are reversed from the Team Coverage page:<br>
            <span style="color: #ff6b6b; font-weight: bold;">Red</span> = Super Effective<br>
            <span style="color: #51cf66; font-weight: bold;">Green</span> = Resisted
        </p>
    </div>

    <div style="max-width: 500px; margin: 0 auto; background: #1a1a1a; padding: 2rem; border-radius: 8px; border: 1px solid #333;">
        <h2 style="margin-top:0; text-align:center;">Pokemon's Type(s)</h2>

        <div class="search-section">
            <input type="text" id="poke-search" list="pokemon-list" placeholder="Search Pokemon..." class="styled-input">
            <button onclick="clearSearch()" class="styled-btn btn-clear">Clear</button>
        </div>
        <datalist id="pokemon-list"></datalist>

        <div class="column" id="defence-input-column" style="margin-bottom: 1.5rem;">
            </div>

        <div class="search-section purity-theme">
            <input type="text" id="purity-search" list="purity-list" placeholder="Search Purity Pokemon..." class="styled-input">
            <datalist id="purity-list"></datalist>
        </div>
    </div>

    <div style="background: #1a1a1a; padding: 1.5rem; border-radius: 8px; border: 1px solid #333; margin-top: 2rem;">
        <h3 style="margin-top:0; text-align: center;">Incoming Damage Multipliers</h3>
        <div id="defence-results"></div>
    </div>
  </div>

</div>

<script>
/* ===================== CONSTANTS ===================== */

const TYPES = [
  'Ancient','Anime','Baby','Ball','Bean','Bird','Boring','Brat',
  'Bug','Cat','Crab','Dance','Dark','Deez Nuts','Dragon','Electric',
  'Emerald','Every','Fairy','Family','Fast','Fighting','Fire',
  'Firefighting','Florida','Fluffy','Flying','Food','Freak','Friend',
  'Frog','Furry','Future','Gamer','Gaslight','Gatekeep','Gender',
  'Ghost','Girlboss','Goblin','Goku','Grass','Ground','Gun','Guys',
  'Hater','Holy','Ice','Kaiju','Little','Magic','Mario','Monke',
  'Mystery/Typeless','Ninja','Normal','Pikachu','Poison','Psychic',
  'Rat','Reddit','Rock','Sans','Sharp','Silly','Song','Space','Steel',
  'Stellar','Stinky','Sus','Thing','Ugly','Unalive','Uno Reverse','VGC',
  'Vibe','Water','Wealth','Yapper'
];

const TEAM_SIZE = 6;
const MOVES_PER_POKEMON = 4;

/* ===================== HELPERS ===================== */

function populateSelect(select, callback) {
    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "—";
    select.appendChild(empty);

    for (const type of TYPES) {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      select.appendChild(option);
    }

    if(callback) select.addEventListener("change", callback);
}

// Populate Matchup Tab
document.querySelectorAll("#matchup select").forEach(s => populateSelect(s, calculateMatchup));

// Specific Logic for Attack Column Toggle
const atkDualCb = document.getElementById("atk-dual");
const atkS2 = document.getElementById("atk-s2");

atkDualCb.addEventListener("change", () => {
    atkS2.style.display = atkDualCb.checked ? "block" : "none";
    calculateMatchup();
});

// Populate Defence Tab
const defenceInputCol = document.getElementById("defence-input-column");
for(let i=0; i<4; i++) {
    const s = document.createElement("select");
    populateSelect(s, calculateDefence);
    defenceInputCol.appendChild(s);
}

// ===================== POKEMON SEARCH LOGIC =====================

const pokeSearchInput = document.getElementById("poke-search");
const pokeDatalist = document.getElementById("pokemon-list");

const puritySearchInput = document.getElementById("purity-search");
const purityDatalist = document.getElementById("purity-list");

// 1. Load BOTH lists on Startup
window.addEventListener('DOMContentLoaded', async () => {
    // Load Normal Dex
    try {
        const res = await fetch("/pokemon-list");
        const names = await res.json();
        names.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            pokeDatalist.appendChild(opt);
        });
    } catch (e) { console.error("Could not load normal list", e); }

    // Load Purity Dex
    try {
        const res = await fetch("/purity-list");
        const names = await res.json();
        names.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            purityDatalist.appendChild(opt);
        });
    } catch (e) { console.error("Could not load purity list", e); }
});

// ================= NORMAL SEARCH LISTENERS =================

// Trigger on Dropdown Select
pokeSearchInput.addEventListener('input', function() {
    const val = this.value;
    const options = pokeDatalist.options;
    for (let i = 0; i < options.length; i++) {
        if (options[i].value === val) {
            searchPokemon(val);
            break;
        }
    }
});

// Trigger on Enter Key
pokeSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchPokemon(this.value);
    }
});

// ================= PURITY SEARCH LISTENERS =================

// Trigger on Dropdown Select
puritySearchInput.addEventListener('input', function() {
    const val = this.value;
    const options = purityDatalist.options;
    for (let i = 0; i < options.length; i++) {
        if (options[i].value === val) {
            searchPurityPokemon(val);
            break;
        }
    }
});

// Trigger on Enter Key
puritySearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchPurityPokemon(this.value);
    }
});


function clearSearch() {
    // Clear both input boxes
    pokeSearchInput.value = "";
    puritySearchInput.value = "";

    // Clear dropdowns and results
    const selects = document.querySelectorAll("#defence-input-column select");
    selects.forEach(s => s.value = "");
    document.getElementById("defence-results").innerHTML = "";
}

async function searchPokemon(name) {
    if(!name) return;

    // Clear other search bar to avoid confusion
    puritySearchInput.value = "";

    try {
        const res = await fetch("/get-types", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pokemon: name })
        });
        const { types } = await res.json();
        populateAndCalculate(types);
    } catch (e) { console.error(e); }
}

async function searchPurityPokemon(name) {
    if(!name) return;

    // Clear other search bar to avoid confusion
    pokeSearchInput.value = "";

    try {
        const res = await fetch("/get-purity-types", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pokemon: name })
        });
        const { types } = await res.json();
        populateAndCalculate(types);
    } catch (e) { console.error(e); }
}

// Helper to update UI for both search types
async function populateAndCalculate(types) {
    const selects = document.querySelectorAll("#defence-input-column select");
    selects.forEach(s => s.value = "");

    if(types && types.length > 0) {
        types.forEach((t, index) => {
            if(index < selects.length) selects[index].value = t;
        });
        await calculateDefence();
    }
}

/* ===================== LOGIC: MATCHUP ===================== */

async function calculateMatchup() {
    const s1 = document.getElementById("atk-s1");
    const s2 = document.getElementById("atk-s2");
    const dual = document.getElementById("atk-dual");

    const attackers = [];
    if (s1.value) attackers.push(s1.value);
    if (dual.checked && s2.value) attackers.push(s2.value);

    const defenders = [...document.querySelectorAll("#defence-column select")]
      .map(s => s.value).filter(Boolean);

    if (attackers.length === 0 || defenders.length === 0) {
      document.getElementById("result").textContent = "—";
      return;
    }

    try {
      const response = await fetch("/attack", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ attackers, defenders })
      });

      const { multiplier } = await response.json();
      document.getElementById("result").textContent = `${multiplier}×`;
    } catch {
      document.getElementById("result").textContent = "ERR";
    }
}

function clearMatchup() {
    // Reset Attacking Section
    const s1 = document.getElementById("atk-s1");
    const s2 = document.getElementById("atk-s2");
    const dual = document.getElementById("atk-dual");

    s1.value = "";
    s2.value = "";
    dual.checked = false;
    s2.style.display = "none";

    // Reset Defence Section
    const defenders = document.querySelectorAll("#defence-column select");
    defenders.forEach(s => s.value = "");

    // Reset the Multiplier Result Text
    document.getElementById("result").textContent = "—";
}

/* ===================== LOGIC: DEFENCE ===================== */

async function calculateDefence() {
    const types = [...document.querySelectorAll("#defence-input-column select")]
        .map(s => s.value).filter(Boolean);

    const resultDiv = document.getElementById("defence-results");

    if(types.length === 0) {
        resultDiv.innerHTML = "";
        return;
    }

    try {
        const response = await fetch("/defence", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ types })
        });
        const data = await response.json();
        renderTable(resultDiv, data, true);
    } catch (e) { console.error(e); }
}

/* ===================== SHARED: DYNAMIC GROUP RENDERER ===================== */

function renderTable(container, data, isDefence = false) {
  container.innerHTML = "";
  if (!data || Object.keys(data).length === 0) return;

  // Group Data by Value
  const groups = {};
  Object.keys(data).forEach(type => {
      const val = data[type];
      if(!groups[val]) groups[val] = [];
      groups[val].push(type);
  });

  // Sort values ascending for Team page and descending for defence page

  const sortedValues = isDefence
    ? Object.keys(groups).sort((a,b) => parseFloat(b) - parseFloat(a))
    : Object.keys(groups).sort((a,b) => parseFloat(a) - parseFloat(b));

  // Render Each Group
  sortedValues.forEach(valString => {
      const val = parseFloat(valString);
      const types = groups[valString].sort();

      const header = document.createElement("h3");
      header.className = "group-header";
      const label = val
      header.textContent = `${label}×`;

      const grid = document.createElement("div");
      grid.className = "coverage-grid";

      types.forEach(type => {
        const cell = document.createElement("div");
        cell.className = "type-cell";

        const typeHeader = document.createElement("div");
        typeHeader.className = "type-header";
        typeHeader.textContent = type;
        typeHeader.title = type;

        const valueDiv = document.createElement("div");
        valueDiv.className = "type-value";

        if (isDefence) {
            if(val > 1) valueDiv.style.color = "#ff6b6b";
            if(val < 1) valueDiv.style.color = "#51cf66";
        } else {
            if(val > 1) valueDiv.style.color = "#51cf66";
            if(val < 1) valueDiv.style.color = "#ff6b6b";
        }

        if(val !== 1) valueDiv.style.fontWeight = "bold";
        valueDiv.textContent = `${label}×`;

        cell.append(typeHeader, valueDiv);
        grid.appendChild(cell);
      });

      container.appendChild(header);
      container.appendChild(grid);
  });
}

/* ===================== LOGIC: TEAM ===================== */

function makeTypeSelect() {
    const s = document.createElement("select");
    const blank = document.createElement("option");
    blank.value = "";
    blank.textContent = "—";
    s.appendChild(blank);
    TYPES.forEach(t => {
        const o = document.createElement("option");
        o.value = t;
        o.textContent = t;
        s.appendChild(o);
    });
    return s;
}

function clearFullTeam() {
    const rows = document.querySelectorAll("#team-container > div[data-pokemon-block]");
    rows.forEach(row => {
        row._moves.forEach(m => {
            m.s1.value = "";
            m.s2.value = "";
            m.cb.checked = false;
            m.s2.style.display = "none";
        });
    });
    calculateTeam();
}

async function clearSinglePokemon(index) {
    const block = document.querySelector(`div[data-pokemon-index="${index}"]`);
    if (!block || !block._moves) return;

    block._moves.forEach(m => {
        m.s1.value = "";
        m.s2.value = "";
        m.cb.checked = false;
        m.s2.style.display = "none";
    });

    const resultDiv = document.getElementById(`pokemon-${index}`);
    if (resultDiv) resultDiv.innerHTML = "";

    await calculateTeam();
}

function buildTeamUI() {
  const container = document.getElementById("team-container");
  if (container.children.length > 0) return;
  container.innerHTML = "";

  for (let p = 0; p < TEAM_SIZE; p++) {
    const block = document.createElement("div");
    block.style.marginBottom = "1.5rem";
    block.style.position = "relative";
    block.setAttribute("data-pokemon-block", "true");
    block.setAttribute("data-pokemon-index", p);
    block._moves = [];

    const headerRow = document.createElement("div");
    headerRow.style.display = "flex";
    headerRow.style.justifyContent = "space-between";
    headerRow.style.alignItems = "center";
    headerRow.style.marginBottom = "1rem";
    headerRow.innerHTML = `<strong style="margin:0;">Pokemon ${p + 1}</strong>`;

    const clearBtn = document.createElement("button");
    clearBtn.textContent = "Clear";
    clearBtn.classList.add("styled-btn", "btn-clear", "btn-inline");
    clearBtn.style.padding = "0.3rem 0.8rem";
    clearBtn.style.fontSize = "0.8rem";
    clearBtn.onclick = () => clearSinglePokemon(p);

    headerRow.appendChild(clearBtn);
    block.appendChild(headerRow);

    for (let m = 0; m < MOVES_PER_POKEMON; m++) {
      const line = document.createElement("div");
      line.className = "move-row";
      const label = document.createElement("span");
      label.textContent = `Move ${m + 1}:`;
      label.style.minWidth = "60px";
      label.style.fontSize = "0.9rem";

      const s1 = makeTypeSelect();
      const s2 = makeTypeSelect();
      s2.style.display = "none";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = `p${p}m${m}-multi`;

      const cbLabel = document.createElement("label");
      cbLabel.textContent = "Dual Type?";
      cbLabel.setAttribute("for", `p${p}m${m}-multi`);
      cbLabel.style.fontSize = "0.8rem";
      cbLabel.style.cursor = "pointer";

      cb.onchange = () => {
        s2.style.display = cb.checked ? "inline-block" : "none";
        calculateTeam();
      };
      s1.onchange = s2.onchange = calculateTeam;

      line.append(label, s1, cb, cbLabel, s2);
      block._moves.push({ s1, s2, cb });
      block.appendChild(line);
    }

    const result = document.createElement("div");
    result.id = `pokemon-${p}`;
    result.style.marginTop = "1rem";
    block.appendChild(result);
    container.appendChild(block);
  }
}

async function calculateTeam() {
    const rows = document.querySelectorAll("#team-container > div[data-pokemon-block]");
    const fullTeamInputs = [];

    rows.forEach(row => {
        const moves = [];
        row._moves.forEach(m => {
            if (m.s1.value) {
                moves.push(m.cb.checked && m.s2.value ? [m.s1.value, m.s2.value] : [m.s1.value]);
            }
        });
        fullTeamInputs.push(moves);
    });

    try {
        const res = await fetch("/team-coverage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pokemons: fullTeamInputs })
        });
        const { individual, total } = await res.json();

        individual.forEach((data, i) => {
            const div = document.getElementById(`pokemon-${i}`);
            if (data) renderTable(div, data);
            else div.innerHTML = "";
        });

        const totalDiv = document.getElementById("team-total");
        if (total) renderTable(totalDiv, total);
        else totalDiv.innerHTML = "";

    } catch (e) { console.error(e); }
}

/* ===================== SPA NAV ===================== */

document.querySelectorAll("header button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll("header button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    const viewId = btn.dataset.view;
    const viewElement = document.getElementById(viewId);
    if (viewElement) viewElement.classList.add("active");

    const mainContainer = document.getElementById("main-container");
    if (viewId === 'team' || viewId === 'defence') {
        mainContainer.classList.add("wide");
    } else {
        mainContainer.classList.remove("wide");
    }

    if (viewId === "team") buildTeamUI();
  };
});
</script>

</body>
</html>
