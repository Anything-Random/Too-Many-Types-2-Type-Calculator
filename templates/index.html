<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Type Calculator</title>

<style>
/* ================= GLOBAL ================= */
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #111;
  color: #eee;
  padding-bottom: 3rem; 
}

/* ================= HEADER ================= */
header {
  display: flex;
  justify-content: center;
  gap: 1rem;
  padding: 1rem;
  background: #1c1c1c;
  margin-bottom: 2rem;
  border-bottom: 1px solid #333;
}

header button {
  padding: 0.6rem 1.2rem;
  font-size: 1rem;
  background: #333;
  color: #eee;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

header button:hover {
  background: #444;
}

header button.active {
  background: #007acc;
  font-weight: bold;
}

/* ================= LAYOUT ================= */
.container {
  max-width: 900px; /* Default narrow width for Calculator */
  margin: 0 auto;
  padding: 0 1rem;
  transition: max-width 0.3s ease; /* Smooth transition when resizing */
}

.container.wide {
  max-width: 95%; 
}

.view {
  display: none;
}

.view.active {
  display: block;
}

.description {
  background: #222;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #333;
  margin-bottom: 2rem;
  text-align: center;
  color: #ccc;
  line-height: 1.6;
}

.description a {
  color: #66b3ff;
}

/* ================= INPUTS ================= */
select {
  background: #222;
  color: #eee;
  border: 1px solid #444;
  padding: 0.5rem;
  font-size: 1rem;
  border-radius: 4px;
  width: 100%;
  box-sizing: border-box;
}

/* ================= RESULT GRIDS ================= */
.group-header {
  margin-top: 1.5rem;
  margin-bottom: 0.5rem;
  font-size: 1.2rem;
  color: #ccc;
  border-bottom: 1px solid #333;
  padding-bottom: 0.2rem;
}

.coverage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
  gap: 4px; 
}

.type-cell {
  background: #111;
  border: 1px solid #444;
  display: flex;
  flex-direction: column;
}

.type-header {
  background: #222;
  padding: 6px;
  font-size: 0.75rem;
  text-align: center;
  border-bottom: 1px solid #444;
  white-space: nowrap; 
  overflow: hidden;
  text-overflow: ellipsis; 
  font-weight: bold;
}

.type-value {
  padding: 8px;
  text-align: center;
  font-size: 0.9rem;
  flex-grow: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ================= CALCULATOR SPECIFIC ================= */
.calculator {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 2rem;
  align-items: start;
  background: #1a1a1a;
  padding: 2rem;
  border-radius: 8px;
  border: 1px solid #333;
}
  
.column {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}
  
.column h2 {
  margin: 0 0 0.5rem;
  text-align: center;
  font-size: 1.2rem;
  font-weight: 600;
  color: #fff;
  border-bottom: 2px solid #333;
  padding-bottom: 0.5rem;
}

.result {
  font-size: 3.5rem;
  font-weight: bold;
  min-width: 4ch;
  text-align: center;
  padding-top: 3.5rem;
  color: #fff;
  text-shadow: 0 0 10px rgba(255,255,255,0.1);
}

/* ================= TEAM SPECIFIC ================= */
#team-container > div {
  background: #1a1a1a;
  padding: 1.5rem;
  border-radius: 8px;
  border: 1px solid #333;
}

#team-container strong {
  display: block;
  font-size: 1.2rem;
  margin-bottom: 1rem;
  color: #66b3ff;
}

.move-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}
</style>
</head>

<body>

<header>
  <button class="active" data-view="matchup">Move Effectiveness</button>
  <button data-view="team">Team Coverage</button>
  <button data-view="defence">Defensive Match-Up</button>
</header>

<div class="container" id="main-container">
  
  <div class="description">
    <p style="margin-top: 0;">
      This page contains some handy tools for the ROM hack Too Many Types 2,
      available at <a href="https://www.hackdex.app/hack/too-many-types-2" target="_blank">hackdex</a>.
    </p>
  </div>

  <div id="matchup" class="view active">
    
    <div class="description" style="text-align: left; font-size: 0.95rem;">
      <p>
        <strong>How to use:</strong> Select up to two types for the attack, and four types for the defense.
        Remember that you can begin typing with a dropdown box selected to find a type.
      </p>
      <p>
        <em>Disclaimer:</em> I'm not sure how the multi-type attacks work in
        this game, so I gave it my best guess. I calculated the
        type effectiveness of each attack type individually and then
        multiplied them together. I wasn't sure how many types an attack can
        have, so I only allowed for 2. I allowed
        defending pokemon to have up to 4 types to account for
        type-adding moves. I also assume that the Uno Reverse type
        works by taking the reciprocal of the normal type effectiveness,
        and immunity becomes 2x.
        I wasn't sure how the Every type works, but I just used the numbers
        presented in the type chart.
        If anyone has any corrections or suggestions they can message
        me in the Too Many Productions discord @anything_random.
      </p>
    </div>

    <div class="calculator">
      <div class="column" id="attack-column">
        <h2>Attacking Move Type(s)</h2>
        <select id="atk-s1"></select>

        <div style="display:flex; align-items:center; gap:0.5rem;">
            <input type="checkbox" id="atk-dual">
            <label for="atk-dual" style="cursor:pointer; font-size:0.9rem;">Dual Type?</label>
        </div>

        <select id="atk-s2" style="display:none;"></select>
      </div>

      <div class="result" id="result">—</div>

      <div class="column" id="defence-column">
        <h2>Defence Type(s)</h2>
        <select></select>
        <select></select>
        <select></select>
        <select></select>
      </div>
    </div>
  </div>

  <div id="team" class="view">
    <div class="description" style="text-align: left; font-size: 0.95rem;">
      <p>
        <strong>How to use:</strong> Select up to 4 move types for a team of up to 6 pokemon.
        Under each pokemon you can see their individual type coverage, and at the bottom you
        can see your entire team's type coverage.
      </p>
    </div>

    <h2 style="text-align:center; margin-bottom: 1.5rem;">Team Coverage</h2>

    <div style="text-align: right; margin-bottom: 1rem;">
      <button onclick="clearFullTeam()" style="padding: 0.5rem 1rem; border: none; background: #cc3333; color: white; border-radius: 4px; cursor: pointer; font-weight: bold;">Clear All</button>
    </div>

    <div id="team-container"></div>

    <div style="background: #1a1a1a; padding: 1.5rem; border-radius: 8px; border: 1px solid #333; margin-top: 2rem;">
        <h3 style="margin-top:0; text-align: center;">Full Team Coverage</h3>
        <div id="team-total"></div>
    </div>
  </div>

  <div id="defence" class="view">
    <div class="description" style="text-align: left; font-size: 0.95rem;">
        <p>
          <strong>How to use:</strong> Search for a Pokemon below OR select up to 4 types manually.
          The grid below will show how effective every type is against it.
        </p>
        <p>
            Colours are reversed from the Team Coverage page:<br>
            <span style="color: #ff6b6b; font-weight: bold;">Red</span> numbers mean you take super-effective damage.<br>
            <span style="color: #51cf66; font-weight: bold;">Green</span> numbers mean you resist the damage.
        </p>
    </div>

    <div style="max-width: 500px; margin: 0 auto; background: #1a1a1a; padding: 2rem; border-radius: 8px; border: 1px solid #333;">
        <h2 style="margin-top:0; text-align:center;">Your Pokemon's Type(s)</h2>

        <div style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1.5rem;">
            <input type="text" id="poke-search" list="pokemon-list" placeholder="Search Pokemon..."
                style="padding: 0.5rem; width: 70%; border-radius: 4px; border: 1px solid #444; background: #222; color: #eee;">

            <button onclick="clearSearch()" style="padding: 0.5rem 1rem; border: none; background: #cc3333; color: white; border-radius: 4px; cursor: pointer;">Clear</button>
        </div>
        <datalist id="pokemon-list"></datalist>

        <div class="column" id="defence-input-column">
            </div>
    </div>

    <div style="background: #1a1a1a; padding: 1.5rem; border-radius: 8px; border: 1px solid #333; margin-top: 2rem;">
        <h3 style="margin-top:0; text-align: center;">Incoming Damage Multipliers</h3>
        <div id="defence-results"></div>
    </div>
  </div>

</div>

<script>
/* ===================== CONSTANTS ===================== */

const TYPES = [
  'Ancient','Anime','Baby','Ball','Bean','Bird','Boring','Brat',
  'Bug','Cat','Crab','Dance','Dark','Deez Nuts','Dragon','Electric',
  'Emerald','Every','Fairy','Family','Fast','Fighting','Fire',
  'Firefighting','Florida','Fluffy','Flying','Food','Freak','Friend',
  'Frog','Furry','Future','Gamer','Gaslight','Gatekeep','Gender',
  'Ghost','Girlboss','Goblin','Goku','Grass','Ground','Gun','Guys',
  'Hater','Holy','Ice','Kaiju','Little','Magic','Mario','Monke',
  'Mystery/Typeless','Ninja','Normal','Pikachu','Poison','Psychic',
  'Rat','Reddit','Rock','Sans','Sharp','Silly','Song','Space','Steel',
  'Stellar','Stinky','Sus','Thing','Ugly','Unalive','Uno Reverse','VGC',
  'Vibes','Water','Wealth','Yapper'
];

const TEAM_SIZE = 6;
const MOVES_PER_POKEMON = 4;

/* ===================== HELPERS ===================== */

function populateSelect(select, callback) {
    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "—";
    select.appendChild(empty);

    for (const type of TYPES) {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      select.appendChild(option);
    }

    if(callback) select.addEventListener("change", callback);
}

// Populate Matchup Tab
document.querySelectorAll("#matchup select").forEach(s => populateSelect(s, calculateMatchup));

// Specific Logic for Attack Column Toggle
const atkDualCb = document.getElementById("atk-dual");
const atkS2 = document.getElementById("atk-s2");

atkDualCb.addEventListener("change", () => {
    atkS2.style.display = atkDualCb.checked ? "block" : "none";
    calculateMatchup();
});

// Populate Defence Tab
const defenceInputCol = document.getElementById("defence-input-column");
for(let i=0; i<4; i++) {
    const s = document.createElement("select");
    populateSelect(s, calculateDefence);
    defenceInputCol.appendChild(s);
}

// ===================== POKEMON SEARCH LOGIC =====================

const pokeSearchInput = document.getElementById("poke-search");
const pokemonDatalist = document.getElementById("pokemon-list");

// Load Pokemon Names on Startup
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const res = await fetch("/pokemon-list");
        const names = await res.json();
        const datalist = document.getElementById("pokemon-list");
        names.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            datalist.appendChild(opt);
        });
    } catch (e) { console.error("Could not load pokemon list", e); }
});

// 1. Submit when an item is selected from the datalist dropdown
pokeSearchInput.addEventListener('input', function() {
    const val = this.value;
    const options = pokemonDatalist.options;

    for (let i = 0; i < options.length; i++) {
        if (options[i].value === val) {
            searchPokemon();
            break;
        }
    }
});

// 2. Submit when the "Enter" key is pressed
pokeSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchPokemon();
    }
});

// Function to reset the search and the dropdowns
function clearSearch() {
    document.getElementById("poke-search").value = "";
    const selects = document.querySelectorAll("#defence-input-column select");
    selects.forEach(s => s.value = "");

    // Clear the results grid
    document.getElementById("defence-results").innerHTML = "";
}

async function searchPokemon() {
    const name = pokeSearchInput.value;
    if(!name) return;

    try {
        const res = await fetch("/get-types", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pokemon: name })
        });

        // Destructuring to avoid "unresolved variable" warnings
        const { types } = await res.json();

        const selects = document.querySelectorAll("#defence-input-column select");

        // Reset all selects first
        selects.forEach(s => s.value = "");

        if(types && types.length > 0) {
            types.forEach((t, index) => {
                if(index < selects.length) {
                    selects[index].value = t;
                }
            });
            // Automatically run calculation and wait for it
            await calculateDefence();
        }
    } catch (e) {
        console.error("Error fetching Pokemon data:", e);
    }
}

/* ===================== LOGIC: MATCHUP ===================== */

async function calculateMatchup() {
    const s1 = document.getElementById("atk-s1");
    const s2 = document.getElementById("atk-s2");
    const dual = document.getElementById("atk-dual");

    const attackers = [];
    if (s1.value) attackers.push(s1.value);
    if (dual.checked && s2.value) attackers.push(s2.value);

    const defenders = [...document.querySelectorAll("#defence-column select")]
      .map(s => s.value).filter(Boolean);

    if (attackers.length === 0 || defenders.length === 0) {
      document.getElementById("result").textContent = "—";
      return;
    }

    try {
      const response = await fetch("/attack", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ attackers, defenders })
      });

      // Destructure the multiplier property directly from the JSON
      const { multiplier } = await response.json();

      document.getElementById("result").textContent = `${multiplier}×`;
    } catch {
      document.getElementById("result").textContent = "ERR";
    }
}

/* ===================== LOGIC: DEFENCE ===================== */

async function calculateDefence() {
    const types = [...document.querySelectorAll("#defence-input-column select")]
        .map(s => s.value).filter(Boolean);

    const resultDiv = document.getElementById("defence-results");

    if(types.length === 0) {
        resultDiv.innerHTML = "";
        return;
    }

    try {
        const response = await fetch("/defence", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ types })
        });
        const data = await response.json();
        renderTable(resultDiv, data, true);
    } catch (e) { console.error(e); }
}

/* ===================== SHARED: DYNAMIC GROUP RENDERER ===================== */

function renderTable(container, data, isDefence = false) {
  container.innerHTML = "";
  if (!data || Object.keys(data).length === 0) return;

  // 1. Group Data by Value
  const groups = {};
  Object.keys(data).forEach(type => {
      const val = data[type];
      if(!groups[val]) groups[val] = [];
      groups[val].push(type);
  });

  // 2. Sort Values Ascending
  const sortedValues = Object.keys(groups).sort((a,b) => parseFloat(a) - parseFloat(b));

  // 3. Render Each Group
  sortedValues.forEach(valString => {
      const val = parseFloat(valString);
      const types = groups[valString].sort();

      const header = document.createElement("h3");
      header.className = "group-header";
      const label = Number.isInteger(val) ? val : val.toFixed(2);
      header.textContent = `${label}×`;

      const grid = document.createElement("div");
      grid.className = "coverage-grid";

      types.forEach(type => {
        const cell = document.createElement("div");
        cell.className = "type-cell";

        const typeHeader = document.createElement("div");
        typeHeader.className = "type-header";
        typeHeader.textContent = type;
        typeHeader.title = type;

        const valueDiv = document.createElement("div");
        valueDiv.className = "type-value";

        if (isDefence) {
            if(val > 1) valueDiv.style.color = "#ff6b6b";
            if(val < 1) valueDiv.style.color = "#51cf66";
        } else {
            if(val > 1) valueDiv.style.color = "#51cf66";
            if(val < 1) valueDiv.style.color = "#ff6b6b";
        }

        if(val !== 1) valueDiv.style.fontWeight = "bold";
        valueDiv.textContent = `${label}×`;

        cell.append(typeHeader, valueDiv);
        grid.appendChild(cell);
      });

      container.appendChild(header);
      container.appendChild(grid);
  });
}

/* ===================== LOGIC: TEAM ===================== */

function makeTypeSelect() {
    const s = document.createElement("select");
    const blank = document.createElement("option");
    blank.value = "";
    blank.textContent = "—";
    s.appendChild(blank);
    TYPES.forEach(t => {
        const o = document.createElement("option");
        o.value = t;
        o.textContent = t;
        s.appendChild(o);
    });
    return s;
}

function clearFullTeam() {
    const container = document.getElementById("team-container");
    const blocks = container.querySelectorAll("div[data-pokemon-block]");

    blocks.forEach((block, index) => {
        clearSinglePokemon(index);
    });
}

function clearSinglePokemon(index) {
    const block = document.querySelector(`div[data-pokemon-index="${index}"]`);
    if (!block || !block._moves) return;

    // Reset all selects and checkboxes for this pokemon
    block._moves.forEach(m => {
        m.s1.value = "";
        m.s2.value = "";
        m.cb.checked = false;
        m.s2.style.display = "none";
    });

    // Clear the individual result and refresh the total
    document.getElementById(`pokemon-${index}`).innerHTML = "";
    calculateTeam();
}

function buildTeamUI() {
  const container = document.getElementById("team-container");
  if (container.children.length > 0) return;
  container.innerHTML = "";

  for (let p = 0; p < TEAM_SIZE; p++) {
    const block = document.createElement("div");
    block.style.marginBottom = "1.5rem";
    block.style.position = "relative"; // For button positioning
    block.setAttribute("data-pokemon-block", "true");
    block.setAttribute("data-pokemon-index", p);
    block._moves = [];

    // Header with Individual Clear Button
    const headerRow = document.createElement("div");
    headerRow.style.display = "flex";
    headerRow.style.justifyContent = "space-between";
    headerRow.style.alignItems = "center";
    headerRow.style.marginBottom = "1rem";
    headerRow.innerHTML = `<strong style="margin:0;">Pokemon ${p + 1}</strong>`;

    const clearBtn = document.createElement("button");
    clearBtn.textContent = "Clear";
    clearBtn.style.padding = "0.3rem 0.8rem";
    clearBtn.style.fontSize = "0.8rem";
    clearBtn.style.background = "#444";
    clearBtn.style.color = "#eee";
    clearBtn.style.border = "1px solid #555";
    clearBtn.style.borderRadius = "4px";
    clearBtn.style.cursor = "pointer";
    clearBtn.onclick = () => clearSinglePokemon(p);

    headerRow.appendChild(clearBtn);
    block.appendChild(headerRow);

    for (let m = 0; m < MOVES_PER_POKEMON; m++) {
      const line = document.createElement("div");
      line.className = "move-row";
      const label = document.createElement("span");
      label.textContent = `Move ${m + 1}:`;
      label.style.minWidth = "60px";
      label.style.fontSize = "0.9rem";

      const s1 = makeTypeSelect();
      const s2 = makeTypeSelect();
      s2.style.display = "none";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = `p${p}m${m}-multi`;

      const cbLabel = document.createElement("label");
      cbLabel.textContent = "Dual Type?";
      cbLabel.setAttribute("for", `p${p}m${m}-multi`);
      cbLabel.style.fontSize = "0.8rem";
      cbLabel.style.cursor = "pointer";

      cb.onchange = () => {
        s2.style.display = cb.checked ? "inline-block" : "none";
        calculateTeam();
      };
      s1.onchange = s2.onchange = calculateTeam;

      line.append(label, s1, cb, cbLabel, s2);
      block._moves.push({ s1, s2, cb });
      block.appendChild(line);
    }

    const result = document.createElement("div");
    result.id = `pokemon-${p}`;
    result.style.marginTop = "1rem";
    block.appendChild(result);
    container.appendChild(block);
  }
}

async function calculateTeam() {
  const rows = document.querySelectorAll("#team-container > div[data-pokemon-block]");
  const team = [];

  for (let i = 0; i < rows.length; i++) {
    const moves = [];
    if (!rows[i]._moves) continue;

    for (const m of rows[i]._moves) {
      if (!m.s1.value) continue;
      if (m.cb.checked && m.s2.value)
        moves.push([m.s1.value, m.s2.value]);
      else
        moves.push([m.s1.value]);
    }

    if (moves.length === 0) {
        document.getElementById(`pokemon-${i}`).innerHTML = "";
        continue;
    }

    team.push(moves);
    try {
      const res = await fetch("/coverage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ moves })
      });
      const coverageData = await res.json();
      renderTable(document.getElementById(`pokemon-${i}`), coverageData);
    } catch (e) { console.error(e); }
  }

  const teamTotalDiv = document.getElementById("team-total");
  if (team.length === 0) {
      teamTotalDiv.innerHTML = "";
      return;
  }

  try {
    const teamRes = await fetch("/team-coverage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pokemons: team })
    });
    const totalData = await teamRes.json();
    renderTable(teamTotalDiv, totalData);
  } catch (e) { console.error(e); }
}

/* ===================== SPA NAV ===================== */

document.querySelectorAll("header button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll("header button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    const viewId = btn.dataset.view;
    const viewElement = document.getElementById(viewId);
    if (viewElement) viewElement.classList.add("active");

    const mainContainer = document.getElementById("main-container");
    if (viewId === 'team' || viewId === 'defence') {
        mainContainer.classList.add("wide");
    } else {
        mainContainer.classList.remove("wide");
    }

    if (viewId === "team") buildTeamUI();
  };
});
</script>

</body>
</html>
